<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.5.0/p5.js"></script>
    <script src="p5.sound.js"></script>
    <script>
      let soundFiles = [];
      let currentFile = 0;
      let sound1, sound2, sound3, sound4;
      let nextButton, prevButton;
      let playing = false;
      let loaded = 0;
      let first = true;
      let mic, recorder, soundFile;
      let state = 0;
      let whichAudio = 0;
      let sessionID = 0;
      let recordingID = 0;
      let timer = 10;
      let maxTime = 10;
      let startTime = 0;
      let volumes = [[.7,0,0,0],[.5,1,0,0],[.25,1,.7,0],[0,.7,1,1]];

      let micColor;

      function preload() {
        sound1 = loadSound('sound1.mp3',soundLoaded);
        sound2 = loadSound('sound2.mp3',soundLoaded);
        sound3 = loadSound('sound3.mp3',soundLoaded);
        sound4 = loadSound('sound4.mp3',soundLoaded);
        micColor = color(125,150,175);
        soundFiles = [sound1, sound2, sound3, sound4];
        startTime = Date.now();
        sessionID = floor(Math.random()*1000000).toString();
      }

      function soundLoaded(){
        loaded++;
        print(loaded);
      }

      function setup() {
        createCanvas(windowWidth, windowHeight);
        soundFiles[currentFile].play();
        recordingID = 0;
        // nextButton = createButton('Next');
        // nextButton.mousePressed(nextSound);
        // prevButton = createButton('Prev');
        // prevButton.mousePressed(prevSound);
        setupMic();
      }

      function setupMic(){
        // create an audio in
        mic = new p5.AudioIn();

        // prompts user to enable their browser mic
        mic.start();

        // create a sound recorder
        recorder = new p5.SoundRecorder();

        // connect the mic to the recorder
        recorder.setInput(mic);

        // this sound file will be used to
        // playback & save the recording
        soundFile = new p5.SoundFile();

      }

      function runMic(){
        // ensure audio is enabled
        userStartAudio();
        print("state "+state);
        // make sure user enabled the mic
        if (state === 0 && mic.enabled) {
          print('recording');
          // record to our p5.SoundFile
          recorder.record(soundFile,maxTime);//,saveMic);
          timer = maxTime;
          micColor = color(255,50,10);
          text('Recording!', width/2, height/2);
          recordingID ++;
          state=1;
        }
        else if (state === 1) {
          micColor = color(125,150,175);
          // stop recorder and
          // send result to soundFile
          recorder.stop();
          saveMic();
          state=0;
        }

      }

      function saveMic(){
        soundFile.save('GMesh_ID-'+sessionID+'_Date_'+month()+'-'+day()+'_Take_'+recordingID+'_AtTime_'+floor((Date.now()-startTime)/1000)+'_Stem_'+currentFile+'.wav');
          // save(soundFile, 'GMesh_ID-'+sessionID+'_Date_'+month()+'-'+day()+'_Take_'+recordingID+'_AtTime_'+floor((Date.now()-startTime)/1000)+'_Stem_'+currentFile+'.wav');
      }

      function draw() {
        background(0);
        if(loaded>3){
          
          fill(30,100,150);
          rect(0,0,windowWidth/2,windowHeight);
          fill(50,128,2500);
          rect(windowWidth/2,0,windowWidth,windowHeight);
          fill(255);
          ellipse(windowWidth/2,windowHeight/2,200,200);
          for (var i = 0; i <  currentFile; i++) {
            fill(255,0);
            stroke(0);
            let sized = 50+i*50;
            ellipse(windowWidth/2,windowHeight/2,sized,sized);
          }
          
          if(!first){
            fill(micColor);
            ellipse(windowWidth/2,windowHeight/4,200,200);
            textAlign(CENTER, CENTER);
            fill(0);
            textSize(30);

            if(state==0)
              text("RECORD",windowWidth/2,windowHeight/4);
            else{
              text("SAVE",windowWidth/2,windowHeight/4);
              timer-=deltaTime/1000;
              if(timer<0){
                timer = maxTime;
                
                micColor = color(125,150,175);
                state = 0;
              }
              text(""+floor(timer),windowWidth/2,windowHeight/4-50);

            }
          }
        }
      }

      function mouseClicked() {
        print(dist(mouseX,mouseY,windowWidth/2,windowHeight/4));
        if(dist(mouseX,mouseY,windowWidth/2,windowHeight/4)<100 && !first){
          runMic();
        }
        else{
          if(mouseX>windowWidth/2)
            nextSound();
          else
            prevSound();
        }
      }

      function player(){
        playing = true;
        sound1.play();
        sound1.setVolume(0);
        sound1.loop();
        sound2.play();
        sound2.loop();
        sound2.setVolume(0);
        sound3.play();
        sound3.loop();
        sound3.setVolume(0);
        sound4.play();
        sound4.loop();
        sound4.setVolume(0);
        print("player volumes");
      }

      function nextSound() {
        // soundFiles[currentFile].fade(0, 1);
        print("nextSound");
        if(!first)
          currentFile++;
        else
          first = false;
        if (currentFile > soundFiles.length - 1) {
          currentFile = soundFiles.length - 1;//0;
        }
        if(!playing)
          player();
        // soundFiles[currentFile].play();
        // soundFiles[currentFile].setVolume(0);
        // soundFiles[currentFile].fade(1, 1);
        setVolumes(volumes[currentFile]);
      }

      function prevSound() {
        if(!playing)
          player();
        print("prevSound");
        // soundFiles[currentFile].fade(0, 1);
        if(!first)
          currentFile--;
        else
          first = false;
        if (currentFile < 0) {
          currentFile = 0;//soundFiles.length - 1;
        }
        // soundFiles[currentFile].play();
        // soundFiles[currentFile].setVolume(0);
        // soundFiles[currentFile].fade(1, 1);
        setVolumes(volumes[currentFile]);
      }

      function setVolumes(vol){
        for (var i = soundFiles.length - 1; i >= 0; i--) {
          soundFiles[i].fade(vol[i],3);
        }
      }


    </script>
  </head>
  <body>
    <div>
   
    </div>
  </body>
</html>
